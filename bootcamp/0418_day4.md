## 0418_Day4

## 1. Firebase의 firestore 주요 메서드

- 공부 계기

  - 방명록 페이지(visitors.html)에 댓글을 새로고침해도 사라지지 않도록 구현하는 과정에서 [웹개발 종합반] 강의 내용을 참고하여 Firebase를 사용하게 되었다.
  - Firebase의 firestore에서는 데이터를 관리하기 위한 다양한 메서드를 제공하는데, 파이어베이스 메서드는 이번에 공부를 하면서 처음 접하게 되었다.
  - 그래서 메서드들이 익숙하지 않아서 메서드에 대해서 공부해야겠다고 생각했다.

- 공부 내용

  ### 1. `addDoc()`
    - 기능: 새로운 문서를 컬렉션에 추가한다.
    - 사용법: `addDoc(collectionReference, data)`
    - 예시
      ```javascript
      // "cities" 컬렉션에 새로운 문서를 추가함

      // Firestore의 "cities" 컬렉션에 대한 참조를 생성함
      const collectionRef = collection(db, "cities");

      // 새로운 문서를 "cities" 컬렉션에 추가하고, 추가된 문서의 참조를 docRef 변수에 할당함
      const docRef = await addDoc(collectionRef, {
        name: "Seoul",
        country: "South Korea",
      });
        ```
    - 실제로 구현한 코드
      ```javascript
      writeBtn.addEventListener('click', async function() {
        if (writeTextarea.value === '') {
          alert('내용을 입력해주세요.')
          writeTextarea.focus();
          return
        }

        let dTStrings = replyDate();
        let text = writeTextarea.value;
        let date = dTStrings.dateString;
        let time = dTStrings.timeString;

        await addDoc(collection(db, "comment"), {
          text: text,
          date: date,
          time: time,
          timestamp: new Date(),
        });

        alert('등록되었습니다.')
        window.location.reload();
        writeTextarea.value = '';
      });
      ```

  ### 2. `getDocs()`
    - 기능: 지정된 컬렉션 내의 모든 문서를 가져온다.
    - 사용법: `getDocs(collectionReference)`
    - 예시
       ```javascript
      // "cities" 컬렉션의 모든 문서를 가져옴

      // Firestore의 "cities' 컬렉션에 대한 참조를 생성함
      const collectionRef = collection(db, "cities");

      // "cities" 컬렉션의 모든 문서를 가져오는 쿼리를 실행함
      const querySnapshot = await getDocs(collectionRef);

      // 가져온 각 문서에 대해 반복하면서 데이터를 출력함
      querySnapshot.forEach(doc => {
        console.log(doc.id, " => ", doc.data());
      });
      ```
    - 실제로 구현한 코드
      ```javascript
      // query() 메서드를 이용하여 Firestore에서 "comment" 컬렉션에 대한 쿼리를 생성함
      // orderBy() 메서드를 이용하여 "timestamp" 필드를 기준으로 내림차순으로 정렬하는 조건을 추가함
      // 따라서 가장 최근에 작성된 문서가 먼저 나오게 됨
      // getDocs() 메서드는 해당 쿼리에 맞는 문서들을 비동기적으로 가져옴
      let docs = await getDocs(query(collection(db, "comment"), orderBy("timestamp", "desc")));
      docs.forEach((doc) => {
        let row = doc.data(); // 현재 문서에서 데이터를 가져옴
        let replyId = doc.id; // 현재 문서의 고유한 ID 값을 가져옴
        let text = row['text']; // row 객체의 text 필드에 저장된 데이터를 가져옴
        let date = row['date']; // row 객체의 date 필드에 저장된 데이터를 가져옴
        let time = row['time']; // row 객체의 time 필드에 저장된 데이터를 가져옴

        let unframedHtml = `
        <div class="texts">
          <p class="texts_reply">${text}</p>
          <textarea class="reply_textarea">${text}</textarea>
          <p class="texts_inf">
            <span>${date}</span>
            <span>${time}</span>
            <span class="reply_id">작성자 : ${replyId}</span>
            <button class="fix">수정</button>
            <button class="complete">수정 완료</button>
            <button class="delete">삭제</button>
          </p>
        </div>
        `;
        let html = `<li>${unframedHtml}</li>`

        replySectionList.innerHTML += html
      });
      ```

  ### 3. `getDoc()`
    - 기능: 특정 문서의 데이터를 가져온다.
    - 사용법: `getDoc(documentReference)`
    - 예시
      ```javascript
      // "cities" 컬렉션의 "LA" 문서의 데이터만 가져옴

      // Firestore의 "cities" 컬렉션 내의 "LA" 문서에 대한 참조를 생성함
      const docRef = doc(db, "cities", "LA");

      // "LA" 문서의 데이터를 가져옴
      const docSnap = await getDoc(docRef);

      // 가져온 문서가 존재하는지 확인하고 데이터를 출력함
      if(docSnap.exists()) {
        console.log("Document data: ", docSnap.data());
      } else {
        console.log("No such document.");
      }
      ```
    - 실제로 구현한 코드
      ```javascript
      async function completeReply(target) {
        const textsLi = target.closest("li");
        const fixTextarea = textsLi.querySelector(".reply_textarea");
        const targetIdPosition = textsLi.querySelector(".reply_id").innerText;
        const targetId = targetIdPosition.replace(/작성자\s+:\s/, '');
        // replace() 함수는 문자열에서 특정 패턴을 다른 문자열로 대체하는 역할을 함
        // '/작성자\s+:\s/'는 정규 표현식으로, '작성자 : '라는 패턴을 나타냄
        // 여기서 '\s+'는 하나 이상의 공백 문자를 의미하며, ':' 앞뒤로 공백이 있을 수 있음을 나타냄
        // "''"는 두 번째 매개변수로 대체할 문자열을 나타내며, 여기서는 빈 문자열로 지정하여 해당 패턴을 제거함
        // 즉, targetIdPosition 문자열에서 '작성자 : '라는 패턴을 찾아 제거한 후, 그 결과를 targetId 변수에 할당함

        let dTStrings = replyDate();
        let text = fixTextarea.value;
        let date = dTStrings.dateString;
        let time = dTStrings.timeString;

        let newReply = {
          text: text,
          date: date,
          time: time,
        };

        let docRef = doc(db, "comment", targetId);
        const docSnapshot = await getDoc(docRef);

        if (docSnapshot.exists()) {
          await updateDoc(docRef, newReply)
          alert('코멘트가 수정되었습니다.')
          window.location.reload();
        } else {
          alert('해당 코멘트를 찾을 수 없습니다.')
          window.location.reload();
          return
        };
      };
      ```

  ### 4. `deleteDoc()`
    - 기능: 특정 문서를 삭제한다.
    - 사용법: `deleteDoc(documentReference)`
    - 예시
      ```javascript
      // "cities" 컬렉션의 "LA" 문서의 데이터를 삭제함

      // Firestore의 "cities" 컬렉션 내의 "LA" 문서에 대한 참조를 생성함
      const docRef = doc(db, "cities", "LA");

      // "LA" 문서를 삭제함
      await deleteDoc(docRef);
      ```
    - 실제로 구현한 코드
      ```javascript
      async function deleteReply(target) {
        const removeTarget = target.closest("li");
        const targetIdPosition = removeTarget.querySelector(".reply_id").innerText;
        const targetId = targetIdPosition.replace(/작성자\s+:\s/, '');
        
        const userDoc = doc(db, 'comment', targetId);
        await deleteDoc(userDoc);
        alert('코멘트를 삭제합니다.')
        window.location.reload();
      };
      ```

  ### 5. `updateDoc()`
    - 기능: 특정 문서의 데이터를 업데이트한다.
    - 사용법: `updateDoc(documentReference, data)`
    - 예시
      ```javascript
      // "cities" 컬렉션의 "LA" 문서의 데이터를 업데이트함

      // Firestore의 "cities" 컬렉션 내의 "LA" 문서에 대한 참조를 생성함
      const docRef = doc(db, "cities", "LA");

      // "LA" 문서의 데이터 중 population 필드를 업데이트함
      await updateDoc(docRef, {
        population: 1000000
      });
      ```
    - 실제로 구현한 코드
      ```javascript
      if (docSnapshot.exists()) {
        await updateDoc(docRef, newReply)
        alert('코멘트가 수정되었습니다.')
        window.location.reload();
      } else {
        alert('해당 코멘트를 찾을 수 없습니다.')
        window.location.reload();
        return
      };
      ```

  ### 6. `setDoc()`
    - 기능: 지정된 문서에 데이터를 설정한다. 이미 해당 문서가 존재하면 기존 데이터를 덮어쓴다.
    - 사용법: `setDoc(documentReference, data)`
    - 예시
      ```javascript
      // "cities" 컬렉션의 "LA" 문서에 새로운 데이터를 설정함

      // Firestore의 "cities" 컬렉션 내의 "LA" 문서에 대한 참조를 생성함
      const docRef = doc(db, "cities", "LA");

      // "LA" 문서에 새로운 데이터를 설정함
      // 이미 해당 문서가 존재하면 기존 데이터를 덮어씀
      await setDoc(docRef, {
        name: "Los Angeles",
        state: "California",
        country: "USA"
      });
      ```

  ### 7. `batch()`
    - 기능
      - 여러 Firestore 작업을 하나의 트랜잭션으로 그룹화한다.
      - 여러 Firestore 작업들을 하나의 논리적인 단위로 묶어서 실행하는 것을 의미한다.
      - 이렇게 그룹화된 작업들은 모두 성공하거나 모두 실패하며, 일부만 성공하거나 실패할 수 없다.
      - 즉, 트랜잭션이 시작되면 모든 작업이 성공적으로 완료될 때까지는 어떤 커밋도 변경되지 않는다.
      - 이를 통해 여러 문서를 동시에 추가, 수정, 삭제할 수 있으며, 모든 작업이 성공할 때만 변경사항을 커밋하여 데이터베이스에 적용할 수 있다.
    - 사용법: `batch(db)`
    - 예시
      ```javascript
      // 여러 Firestore 작업을 하나의 트랜잭션으로 그룹화하여 처리함

      // Firebase의 batch를 생성함
      const batch = writeBatch(db);

      // "cities" 컬렉션 내의 "SF" 문서와 "LA" 문서에 대한 참조를 생성함
      const doc1Ref = doc(db, "cities", "SF");
      const doc2Ref = doc(db, "cities", "LA");

      // batch에 문서 추가, 삭제 작업을 추가함
      batch.set(doc1Ref, {name: "San Francisco"});
      batch.delete(doc2Ref);

      // batch를 실행하여 트랜잭션을 커밋함
      // 모든 작업이 성공하거나 모든 작업이 실패하도록 보장함
      await batch.commit();
      ```

  ### 8. `query()`
    - 기능: Firestore 쿼리를 생성한다. 이를 사용하여 조건에 맞는 문서를 검색하거나 정렬할 수 있다.
    - 사용법: `query(collectionReference, ...conditions)`
    - 예시
      ```javascript
      // Firebase 쿼리를 사용하여 조건에 맞는 문서를 검색함

      // "cities" 컬렉션 내에서 인구가 100만 명 이상인 도시를 검색하는 쿼리를 생성함
      const query = query(collection(db, "cities"), where("population", ">", 1000000));

      // 생성한 쿼리를 실행하여 해당하는 문서들을 가져옴
      const querySnapshot = await getDocs(query);

      // 가져온 각 문서에 대해 반복하면서 데이터를 출력함
      querySnapshot.forEach(doc => {
        console.log(doc.id, " => ", doc.data());
      });
      ```

  ### 9. `onSnapshot()`
    - 기능: 지정된 쿼리나 문서에 대한 실시간 업데이트를 구독한다. 데이터가 변경되면 콜백 함수가 호출된다.
    - 사용법: `onSnapshot(queryOrDocumentReference, callback)`
    - 예시
      ```javascript
      // 지정된 쿼리나 문서에 대한 실시간 업데이트를 구독함

      // "cities" 컬렉션을 실시간으로 감시하고 변경사항을 처리하는 함수를 등록함
      const unsubscribe = onSnapshot(collection(db, "cities"), (snapshot) => {
        // 변경된 문서에 대한 정보를 가져와서 처리함
        snapshot.docChanges().forEach((change) => {
          console.log("Document data: ", change.doc.data());
        });
      });

## 2.
